<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retinal Image Enhancer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            text-align: center;
            color: #4a9eff;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .upload-section {
            text-align: center;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }
        .images-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .image-box {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .image-box h3 {
            margin-top: 0;
            color: #4a9eff;
        }
        canvas {
            max-width: 100%;
            border: 2px solid #444;
            border-radius: 5px;
        }
        input[type="file"] {
            display: none;
        }
        .upload-btn {
            background: #4a9eff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .upload-btn:hover {
            background: #3a8eef;
        }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        .control-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #4a9eff;
        }
        input[type="range"] {
            width: 100%;
        }
        .download-btn {
            background: #28a745;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .download-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <h1>Retinal Image Enhancer - Flatten & Sharpen</h1>
    
    <div class="container">
        <div class="upload-section">
            <input type="file" id="imageInput" accept="image/*">
            <label for="imageInput" class="upload-btn">Upload Retinal Image</label>
            <p>Upload your retinal fundus image to enhance it</p>
        </div>

        <div class="controls">
            <h3>Enhancement Controls</h3>
            <div class="control-group">
                <label>Background Removal Strength: <span id="bgValue">30</span></label>
                <input type="range" id="bgStrength" min="10" max="100" value="30">
            </div>
            <div class="control-group">
                <label>Contrast Enhancement: <span id="contrastValue">2.0</span></label>
                <input type="range" id="contrast" min="1" max="3" step="0.1" value="2.0">
            </div>
            <div class="control-group">
                <label>Sharpness: <span id="sharpValue">1.5</span></label>
                <input type="range" id="sharpness" min="0.5" max="3" step="0.1" value="1.5">
            </div>
            <div class="control-group">
                <label>Brightness: <span id="brightValue">20</span></label>
                <input type="range" id="brightness" min="-50" max="50" value="20">
            </div>
        </div>

        <div class="images-container">
            <div class="image-box">
                <h3>Original Image</h3>
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="image-box">
                <h3>Enhanced Image</h3>
                <canvas id="enhancedCanvas"></canvas>
                <button class="download-btn" id="downloadBtn">Download Enhanced Image</button>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const originalCanvas = document.getElementById('originalCanvas');
        const enhancedCanvas = document.getElementById('enhancedCanvas');
        const originalCtx = originalCanvas.getContext('2d');
        const enhancedCtx = enhancedCanvas.getContext('2d');
        
        let currentImage = null;

        // Control elements
        const bgStrength = document.getElementById('bgStrength');
        const contrast = document.getElementById('contrast');
        const sharpness = document.getElementById('sharpness');
        const brightness = document.getElementById('brightness');

        // Update value displays
        bgStrength.addEventListener('input', (e) => {
            document.getElementById('bgValue').textContent = e.target.value;
            if (currentImage) processImage();
        });
        contrast.addEventListener('input', (e) => {
            document.getElementById('contrastValue').textContent = e.target.value;
            if (currentImage) processImage();
        });
        sharpness.addEventListener('input', (e) => {
            document.getElementById('sharpValue').textContent = e.target.value;
            if (currentImage) processImage();
        });
        brightness.addEventListener('input', (e) => {
            document.getElementById('brightValue').textContent = e.target.value;
            if (currentImage) processImage();
        });

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        
                        // Set canvas sizes
                        originalCanvas.width = img.width;
                        originalCanvas.height = img.height;
                        enhancedCanvas.width = img.width;
                        enhancedCanvas.height = img.height;
                        
                        // Draw original
                        originalCtx.drawImage(img, 0, 0);
                        
                        // Process and draw enhanced
                        processImage();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function processImage() {
            if (!currentImage) return;

            // Draw original image to get pixel data
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = currentImage.width;
            tempCanvas.height = currentImage.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(currentImage, 0, 0);
            
            let imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Step 1: Background flattening
            imageData = flattenBackground(imageData, parseInt(bgStrength.value));
            
            // Step 2: Adjust brightness
            imageData = adjustBrightness(imageData, parseInt(brightness.value));
            
            // Step 3: Enhance contrast
            imageData = enhanceContrast(imageData, parseFloat(contrast.value));
            
            // Step 4: Apply sharpening
            imageData = sharpenImage(imageData, parseFloat(sharpness.value));
            
            // Draw result
            enhancedCtx.putImageData(imageData, 0, 0);
        }

        function flattenBackground(imageData, strength) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Calculate average background (simple method)
            const blockSize = Math.max(20, strength);
            const bgMap = new Array(width * height).fill(0);
            
            // Estimate background using maximum filter
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let sum = 0, count = 0;
                    
                    for (let dy = -blockSize; dy <= blockSize; dy += 5) {
                        for (let dx = -blockSize; dx <= blockSize; dx += 5) {
                            const ny = Math.min(Math.max(y + dy, 0), height - 1);
                            const nx = Math.min(Math.max(x + dx, 0), width - 1);
                            const idx = (ny * width + nx) * 4;
                            const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                            sum += gray;
                            count++;
                        }
                    }
                    
                    bgMap[y * width + x] = sum / count;
                }
            }
            
            // Subtract background
            for (let i = 0; i < data.length; i += 4) {
                const idx = Math.floor(i / 4);
                const bg = bgMap[idx];
                
                for (let c = 0; c < 3; c++) {
                    data[i + c] = Math.min(255, Math.max(0, data[i + c] - bg + 128));
                }
            }
            
            return imageData;
        }

        function adjustBrightness(imageData, value) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, data[i] + value));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + value));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + value));
            }
            return imageData;
        }

        function enhanceContrast(imageData, factor) {
            const data = imageData.data;
            const middle = 128;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, middle + factor * (data[i] - middle)));
                data[i + 1] = Math.min(255, Math.max(0, middle + factor * (data[i + 1] - middle)));
                data[i + 2] = Math.min(255, Math.max(0, middle + factor * (data[i + 2] - middle)));
            }
            
            return imageData;
        }

        function sharpenImage(imageData, amount) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const newData = new Uint8ClampedArray(data);
            
            const kernel = [
                0, -amount, 0,
                -amount, 1 + 4 * amount, -amount,
                0, -amount, 0
            ];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                const kernelIdx = (ky + 1) * 3 + (kx + 1);
                                sum += data[idx] * kernel[kernelIdx];
                            }
                        }
                        
                        const idx = (y * width + x) * 4 + c;
                        newData[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = newData[i];
            }
            
            return imageData;
        }

        // Download functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const link = document.createElement('a');
            link.download = 'enhanced_retinal_image.png';
            link.href = enhancedCanvas.toDataURL();
            link.click();
        });
    </script>
</body>
</html>